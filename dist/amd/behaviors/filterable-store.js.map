{"version":3,"sources":["../../../src/behaviors/filterable-store.js"],"names":[],"mappings":"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","file":"filterable-store.js","sourcesContent":["import angular from 'angular';\nimport {Behavior} from './behavior';\nimport {Handler as handlerDecorator} from '../store';\n\nimport {\n  Transformer,\n  Transformable as transformableDecorator\n} from './transformable';\n\nimport {\n  addBehavior,\n  camelcase,\n  Inject as injectDecorator\n} from '../utils';\n\nexport class FilterableStoreBehavior extends Behavior {\n  constructor(instance, {collection} = {}) {\n    super(...arguments);\n\n    this.collection = collection || 'items';\n    this.transformerWeight = 25;\n    this.filters = new Map();\n  }\n\n  get $filter() {\n    return this.instance.$filter;\n  }\n\n  get transformableCollection() {\n    return this.instance.transformables[this.collection];\n  }\n\n  get transformer() {\n    if (!this._transformer) {\n      this._transformer = new Transformer('filterableStore', items => items, this.transformerWeight);\n    }\n    return this._transformer;\n  }\n\n  onFilterChange(filterName, filter) {\n    if (Reflect.apply(Object.prototype.toString, filter) === '[object String]') {\n      this.filters.set(filterName, items => {\n        return this.$filter('filter')(items, filter);\n      });\n    } else {\n      this.filters.set(filterName, items => {\n        return items.filter(item => {\n\n          const exclude = filter.exclude;\n          const filterProperty = filter.property;\n          let filterValues = filter.value;\n          const value = item[filterProperty];\n\n          if (filterValues) {\n            if (!Array.isArray(filterValues)) {\n              filterValues = [filterValues];\n            }\n\n            for (const filterValue of filterValues) {\n              if (value === filterValue) {\n                return !exclude;\n              }\n            }\n          }\n\n          return Boolean(exclude);\n        });\n      });\n    }\n\n    this.doFilter();\n  }\n\n  onFilterClear(filterName) {\n    this.filters.delete(filterName);\n    this.doFilter();\n  }\n\n  onSearchChange(expression) {\n    this.onFilterChange('__search', expression);\n  }\n\n  onSearchClear() {\n    this.onFilterClear('__search');\n  }\n\n  doFilter() {\n    const collection = this.transformableCollection;\n    const transformer = this.transformer;\n\n    transformer.fn = items => {\n      let filtered = items.slice();\n\n      for (const filterFn of this.filters.values()) {\n        filtered = filterFn(filtered);\n      }\n\n      return filtered;\n    };\n\n    if (collection.transformers.indexOf(transformer) >= 0) {\n      collection.refresh();\n    } else {\n      collection.addTransformer(transformer);\n    }\n  }\n}\n\nexport function FilterableStore(config) {\n  return cls => {\n    let preparedConfig = config;\n    if (angular.isString(config)) {\n      preparedConfig = {entity: config};\n    }\n\n    preparedConfig = Object.assign({\n      collection: 'items',\n      entity: cls.name.replace(/store$/i, '')\n    }, preparedConfig);\n    preparedConfig.entity = camelcase(preparedConfig.entity);\n\n    injectDecorator()(cls.prototype, '$filter');\n    transformableDecorator()(cls.prototype, preparedConfig.collection);\n\n    const filterChangeHandlerName = `on${preparedConfig.entity}FilterChange`;\n    const filterClearHandlerName = `on${preparedConfig.entity}FilterClear`;\n    handlerDecorator(null, false)(cls.prototype, filterChangeHandlerName);\n    handlerDecorator(null, false)(cls.prototype, filterClearHandlerName);\n\n    const searchChangeHandlerName = `on${preparedConfig.entity}SearchChange`;\n    const searchClearHandlerName = `on${preparedConfig.entity}SearchClear`;\n    handlerDecorator(null, false)(cls.prototype, searchChangeHandlerName);\n    handlerDecorator(null, false)(cls.prototype, searchClearHandlerName);\n\n    addBehavior(cls, FilterableStoreBehavior, {\n      property: 'filterableStore',\n      config: preparedConfig,\n      proxy: [\n        `${filterChangeHandlerName}:onFilterChange`,\n        `${filterClearHandlerName}:onFilterClear`,\n        `${searchChangeHandlerName}:onSearchChange`,\n        `${searchClearHandlerName}:onSearchClear`\n      ]\n    });\n  };\n}\n"]}